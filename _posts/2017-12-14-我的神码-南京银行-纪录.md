---
layout:     post
title:      xxx银行历险记
subtitle:   我的神码
date:       2017-12-14
author:     刘少涛
header-img: img/post-bg-ios9-web.jpg
catalog: true
tags:
    java
    java
---

### 前言

不知不觉大学毕业也已两年半，工作时间也不算短，回想当初刚工作时所做的职业规划，再回过头来看是否已经达到预期的标准！
我以前从来不写博客，但通过在网上查过很多资料后发现许多的技术大牛们都是通过博客来记录工作中所遇到的各种问题，
所以现在也开始通过这种方式来记录自己的职业生涯，也让自己的职业生涯有迹可寻。
### 技术篇

来神州数码工作也已经有七个月了，神码的ECI产品已经全部接触过，期间南京银行主要开发的产品有ECIS(银联前置),
ECSS(银联对账),NCPAY(无卡支付),NCSS(无卡对账),EC_GW(网关转发),OM(后台管理)等！

#### 报文
银联前置，顾名思义，就是连接银联与银行各个系统的中间系统，所以与银联前置既需要与银联通讯也需要与银行的系统通讯，所以就有了报文。
8583报文 银联给全国各家银行制定报文标准，这种报文通过报文头+位图+报文体来实现数据的传输，报文体积最小，该报文制定了128个域，每个域都已规定好了需要传输的数据内容与数据格式，位图是由32个16进制的数表示，16进制的数可以表示成1111，故32*4=128。所以位图表示的是128个域中需要传数据的域名。

CD SOAP 
http://www.runoob.com/soap/soap-tutorial.html，
这两种报文归根结底都是xml报文，
http://www.runoob.com/xml/xml-tutorial.html
XML被设计用来传输和存储数据，故银联前置与银行的系统通讯都是通过这两种报文格式，但是xml报文的体积是最大的。

定长报文，顾名思义固定长度的报文，体积最小，报文本身只有数据。一般用来与银联数据做通讯，银联数据是一些银行老架构的产物，银联数据一般会存放贷记卡，芯片卡的信息。故银联前置系统的贷记卡交易与芯片卡交易都是直接与银联数据通讯，再由银联数据转发银联
#### 协议
http://www.runoob.com/soap/soap-httpbinding.html
http/https HTTP 在 TCP/IP 之上进行通信。HTTP 客户机使用 TCP 连接到 HTTP 服务器。在建立连接之后，客户机可向服务器发送 HTTP 
请求消息：
POST /item HTTP/1.1
Host: 189.123.255.239
Content-Type: text/plain
Content-Length: 200
随后服务器会处理此请求，然后向客户机发送一个 HTTP 响应。此响应包含了可指示请求状态的状态代码：
200 OK
Content-Type: text/plain
Content-Length: 200

SOAP HTTP Binding
SOAP 方法指的是遵守 SOAP 编码规则的 HTTP 请求/响应。
HTTP + XML = SOAP
SOAP 请求可能是 HTTP POST 或 HTTP GET 请求。
HTTP POST 请求规定至少两个 HTTP 头：Content-Type 和 Content-Length。

tcp/ip
http://www.runoob.com/tcpip/tcpip-tutorial.html
TCP/IP 寻址
TCP/IP 使用 32 个比特或者 4 组 0 到 255 之间的数字来为计算机编址。
IP地址
每个计算机必须有一个 IP 地址才能够连入因特网。
每个 IP 包必须有一个地址才能够发送到另一台计算机。
IP 地址包含 4 组数字：
TCP/IP 使用 4 组数字来为计算机编址。每个计算机必须有一个唯一的 4 组数字的地址。
每组数字必须在 0 到 255 之间，并由点号隔开，比如：192.168.1.60。

webservice
http://www.runoob.com/webservices/ws-intro.html
什么是Web Services？
Web Services 是应用程序组件
Web Services 使用开放协议进行通信
Web Services 是独立的（self-contained）并可自我描述
Web Services 可通过使用UDDI来发现
Web Services 可被其他应用程序使用
XML 是 Web Services 的基础

WSDL
http://www.runoob.com/wsdl/wsdl-intro.html
什么是 WSDL?
WSDL 指网络服务描述语言
WSDL 使用 XML 编写
WSDL 是一种 XML 文档
WSDL 用于描述网络服务
WSDL 也可用于定位网络服务
WSDL 还不是 W3C 标准
#### java

^_^哈哈。
JDK（Java Development Kit ）：编写Java程序的程序员使用的软件
JRE（Java Runtime Environment）：运行Java程序的用户使用的软件
Server JRE （Java SE Runtime Environment）：服务端使用的 Java 运行环境
SDK（Software Development Kit）：软件开发工具包，在Java中用于描述1998年~2006年之间的JDK
DAO（Data Access Object）：数据访问接口，数据访问，顾名思义就是与数据库打交道
MVC（Model View Controller）：模型(model)－视图(view)－控制器(controller)的缩写，一种软件设计典范，用于组织代码用一种业务逻辑和数据显示分离的方法


目前ECI平台使用java+mybatis进行数据的持久化，没有DAO层，先通过xml的格式的来定义context需要的字段，再通过context中将定义好的字段加载进sdo来实现DAO层的功能。通过java的静态方法去加载应用需要的参数，分为固定参数与数据库参数，数据库参数一般是可变化的。
#### 配置管理
SVN ClearCase Git
配置管理库之前用的是SVN，目前切换到clearcase，通过使用配置管理库来提高团队的效率，一款好的配置管理工具有助于团队

SVN是Subversion的简称，简单一点SVN就是用于多个人共同开发同一个项目，共用资源的目的
缺点
1、服务器压力太大，数据库容量暴增。
2、如果不能连接到服务器上，基本上不可以工作，看上面第二步，如果服务器不能连接上，就不能提交，还原，对比等等。
3、不适合开源开发。但是一般集中式管理的有非常明确的权限管理机制（例如分支访问限制），可以实现分层管理，从而很好的解决开发人数众多的问题。
优点
1、管理方便，逻辑明确，符合一般人思维习惯。
2、易于管理，集中式服务器更能保证安全性。
3、代码一致性非常高。
4、适合开发人数不多的项目开发。
5、大部分软件配置管理的大学教材都是使用svn和vss

ClearCase主要应用于复杂的产品发放、分布式团队合作、并行的开发和维护任务，包括支持当今流行软件开发环境Client/Server网络结构。在激烈的市场竞争中，ClearCase的特点直接响应了软件团队的需求，ClearCase更像是一个配置管理系统，需要有专门的配置管理员维护，流程复杂。

Git是一个开源的分布式版本控制系统，用于敏捷高效地处理任何或小或大的项目
Git 与 SVN 区别
GIT不仅仅是个版本控制系统，它也是个内容管理系统(CMS),工作管理系统等。
如果你是一个具有使用SVN背景的人，你需要做一定的思想转换，来适应GIT提供的一些概念和特征。
Git 与 SVN 区别点：
1、GIT是分布式的，SVN不是：这是GIT和其它非分布式的版本控制系统，例如SVN，CVS等，最核心的区别。
2、GIT把内容按元数据方式存储，而SVN是按文件：所有的资源控制系统都是把文件的元信息隐藏在一个类似.svn,.cvs等的文件夹里。
3、GIT分支和SVN的分支不同：分支在SVN中一点不特别，就是版本库中的另外的一个目录。
4、GIT没有一个全局的版本号，而SVN有：目前为止这是跟SVN相比GIT缺少的最大的一个特征。
5、GIT的内容完整性要优于SVN：GIT的内容存储使用的是SHA-1哈希算法。这能确保代码内容的完整性，确保在遇到磁盘故障和网络问题时降低对版本库的破坏。

Git 并不像 SVN 那样有个中心服务器。
目前我们使用到的 Git 命令都是在本地执行，如果你想通过 Git 分享你的代码或者与其他开发人员合作。 你就需要将数据放到一台其他开发人员能够连接的服务器上。
本例使用了 Github 作为远程仓库
github是一个基于git的代码托管平台，付费用户可以建私人仓库，我们一般的免费用户只能使用公共仓库，也就是代码要公开。
### 业务篇

银联 银联前置系统关注的业务主要是银联业务，一家银行想要与其他银行系统通信，一般都是需要通过银联来建立连接。所以银联的交易都是本代他，他代本的交易。
所以银联前置的最主要功能就是记录与中国银联的来往张交易，并且将他代本的交易发往银行其他系统，由因为银联前置是和银联和银行核心在交互，所以银联前置需要核对银联与核心的清算文件，确保银行的账务正确。

核心 银行的核心系统，所有账务都在这里记录。客户的存款信息，利息计算，会计分录都发生在这里，银行最终需要这样一个公式 资产=负债+所有者权益

渠道 ATM 网银 银联 柜面等这些渠道都是通过银行的不同终端过来，需要通过渠道区分交易的处理方式，通过支持不同的渠道可以使银行的系统更强大。更好的服务客户。



### 心得总结
xxx银行的银联前置已经上线三个多月，上线之后中间出过许多问题，一直想找个时间复盘一下，却迟迟未做，一直拖到现在。

#### 上线前

xxx银行银联前置是从六月中旬开始做的，六月份到七月份刚开始接触ECI平台，刚开始交易的开发很慢，大概在进场后的一个礼拜拿到了保定银行的版本，当时我从基地带来了一个版本，但是后来没有用上，在保定银行的版本上开发了一个礼拜后，我们切换了保定银行的platform，这个时候大家心里都有些慌，因为不确定新的platfrom变化到底有多大，开发了两个礼拜之后xxx银行的版本逐渐出现。

七月初我们开始开发交易
1.因为xxx银行的报文是soap，xxx版本是cd报文，大家在修改cd报文的metadata时，不知道是应该保留还是删除，最终都将原cd的metadata全部保留了下来，现在回头来看是多此一举了。
2.xxx版本交易的渠道没有拆分开，都是在同一个代理服务下去做的判断，xxx银行的老系统架构又需要将这些交易的渠道拆分开。也就是同一个交易用两个代理服务处理不同的渠道，当时的代码开发没有按照这样的模式去完成，导致花费了大量时间去重新拆分这些交易。
3.系统测试，由于xxx银行工期较短，银联前期只有四个人在开发，导致测试的的不够详细，一些异常情况没有测全，虽然银联的在线案例最终都过了，但这也为后来上线之后埋下很大祸根。
4.银联对账，银联对账开发的太晚，大概在上线前一个礼拜对账系统的功能还没有完成。对账系统可以和应用同时并行开发，在设计初期就可以很早就发现对账的问题可以及时解决，也可以即使设计流水表的对账字段，不至于太过被动。
5.xxx银行前置的系统架构设计是三个，两个村镇，一个总行，三家各不相干。但是前期测试一直都是在总行的应用上，没有分成三个服务去严格测试，导致在上线前一个礼拜才发现生成全局流水会一直重复。

#### 上线当天

上线当天最为狼狈，四进四出线路出现问题，江苏银联应用可以实现随机一条线路返回，异地银联竟然没有收到往账返回的报文，目前这是一个悬案，还在调查中，清楚记得异地银联双网关的xxxxx端口只建立了一条链路，而江苏银联的网关的双网关设置是两条链路。目前怀疑要么网络问题，要么网关不支持一台服务器布置多台网关，暂时还未验证。数据库参数没有导全。在各种紧张中银联前置早上8点开始投产。



#### 上线后

银联前置目前发现过的bug，回过头来看主要是1.测试时不够详细，2.没有完整的回归测试方案，3.前期的需求设计不够完成。

